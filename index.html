<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Bapper Hat Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      padding: 20px;
      text-align: center;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      padding: 30px;
    }

    .controls-panel {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      height: fit-content;
    }

    .feature-section {
      margin-bottom: 30px;
      padding-bottom: 25px;
      border-bottom: 2px solid #e9ecef;
    }

    .feature-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .feature-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feature-icon {
      width: 24px;
      height: 24px;
      background: #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: #f8f9ff;
      transition: all 0.3s ease;
      cursor: pointer;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .upload-area:hover, .upload-area:focus {
      border-color: #5a67d8;
      background: #f0f4ff;
      outline: none;
    }

    .upload-area.dragover {
      border-color: #4c51bf;
      background: #e6fffa;
    }

    .upload-input {
      display: none;
    }

    .upload-text {
      color: #667eea;
      font-weight: 500;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .upload-hint {
      color: #718096;
      font-size: 0.9rem;
    }

    .hat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .hat-option {
      border: 3px solid transparent;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      text-align: center;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      touch-action: manipulation;
    }

    .hat-option:hover, .hat-option:focus {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      outline: none;
    }

    .hat-option:active {
      transform: translateY(0);
    }

    .hat-option.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .hat-preview {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .hat-name {
      font-size: 0.8rem;
      color: #4a5568;
      font-weight: 500;
    }

    .controls-info {
      background: #e6fffa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
    }

    .controls-info h4 {
      color: #2d3748;
      margin-bottom: 10px;
    }

    .controls-info ul {
      list-style: none;
      color: #4a5568;
    }

    .controls-info li {
      margin-bottom: 5px;
      padding-left: 20px;
      position: relative;
    }

    .controls-info li:before {
      content: "•";
      color: #667eea;
      font-weight: bold;
      position: absolute;
      left: 0;
    }

    .canvas-area {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
    }

    .canvas-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    #canvas {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      max-width: 100%;
      height: auto;
      touch-action: none;
    }

    .download-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      min-height: 50px;
      touch-action: manipulation;
    }

    .download-btn:hover, .download-btn:focus {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      outline: none;
    }

    .download-btn:active {
      transform: translateY(0);
    }

    .download-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }

      .container {
        border-radius: 15px;
      }

      .header {
        padding: 15px;
      }

      .header h1 {
        font-size: 1.8rem;
        margin-bottom: 8px;
      }

      .header p {
        font-size: 1rem;
      }

      .main-content {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px;
      }

      .controls-panel {
        padding: 20px;
      }

      .feature-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
      }

      .feature-title {
        font-size: 1.2rem;
        margin-bottom: 12px;
      }

      .upload-area {
        padding: 20px;
        min-height: 100px;
      }

      .upload-text {
        font-size: 0.9rem;
      }

      .upload-hint {
        font-size: 0.8rem;
      }

      .hat-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .hat-option {
        padding: 8px;
        min-height: 90px;
      }

      .hat-preview {
        width: 50px;
        height: 50px;
        margin-bottom: 6px;
      }

      .hat-name {
        font-size: 0.75rem;
      }

      .controls-info {
        padding: 15px;
      }

      .controls-info h4 {
        font-size: 0.9rem;
        margin-bottom: 8px;
      }

      .controls-info li {
        font-size: 0.8rem;
        margin-bottom: 4px;
      }

      .canvas-area {
        padding: 15px;
      }

      .canvas-container {
        padding: 15px;
      }

      #canvas {
        width: 100%;
        max-width: 100%;
      }

      .download-btn {
        padding: 12px 25px;
        font-size: 1rem;
        width: 100%;
        max-width: 300px;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.5rem;
      }

      .header p {
        font-size: 0.9rem;
      }

      .main-content {
        padding: 15px;
        gap: 15px;
      }

      .controls-panel {
        padding: 15px;
      }

      .feature-title {
        font-size: 1.1rem;
      }

      .feature-icon {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }

      .upload-area {
        padding: 15px;
        min-height: 80px;
      }

      .hat-grid {
        gap: 10px;
      }

      .hat-option {
        padding: 6px;
        min-height: 80px;
      }

      .hat-preview {
        width: 40px;
        height: 40px;
      }

      .hat-name {
        font-size: 0.7rem;
      }

      .canvas-area {
        padding: 10px;
      }

      .canvas-container {
        padding: 10px;
      }

      .download-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
      }
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .hat-option:hover {
        transform: none;
        box-shadow: none;
      }

      .download-btn:hover {
        transform: none;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .upload-area:hover {
        border-color: #667eea;
        background: #f8f9ff;
      }
    }

    /* Landscape orientation on mobile */
    @media (max-width: 768px) and (orientation: landscape) {
      .main-content {
        grid-template-columns: 1fr 1.5fr;
        gap: 15px;
      }

      .hat-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }

      .hat-option {
        min-height: 70px;
      }

      .hat-preview {
        width: 35px;
        height: 35px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1> ₿appers PFP Generator</h1>
      <p>Create amazing pfp combinations with your photos!</p>
    </div>

    <div class="main-content">
      <div class="controls-panel">
        <!-- Feature 1: Upload Image -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">1</div>
            Upload Any Image
          </div>
          <div class="upload-area" onclick="document.getElementById('upload').click()" role="button" aria-label="Upload image area" tabindex="0">
            <input type="file" id="upload" class="upload-input" accept="image/*" aria-label="Upload image" />
            <div class="upload-text">📸 Click to upload your image</div>
            <div class="upload-hint">or drag and drop here</div>
          </div>
        </div>

        <!-- Feature 2: Choose Hat -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">2</div>
            Choose from 8 Hats
          </div>
          <div class="hat-grid">
            <div class="hat-option" data-hat="hat1.png" role="button" aria-label="Select Orange Hat" tabindex="0">
              <img src="hat1.png" alt="Orange Hat" class="hat-preview">
              <div class="hat-name">Orange</div>
            </div>
            <div class="hat-option" data-hat="hat2.png" role="button" aria-label="Select Black & Red Hat" tabindex="0">
              <img src="hat2.png" alt="Black & Red Hat" class="hat-preview">
              <div class="hat-name">Black & Red</div>
            </div>
            <div class="hat-option" data-hat="hat3.png" role="button" aria-label="Select Green & Yellow Hat" tabindex="0">
              <img src="hat3.png" alt="Green & Yellow Hat" class="hat-preview">
              <div class="hat-name">Green & Yellow</div>
            </div>
            <div class="hat-option" data-hat="hat4.png" role="button" aria-label="Select Blue & White Hat" tabindex="0">
              <img src="hat4.png" alt="Blue & White Hat" class="hat-preview">
              <div class="hat-name">Blue & White</div>
            </div>
            <div class="hat-option" data-hat="hat5.png" role="button" aria-label="Select Red & Gray Hat" tabindex="0">
              <img src="hat5.png" alt="Red & Gray Hat" class="hat-preview">
              <div class="hat-name">Red & Gray</div>
            </div>
            <div class="hat-option" data-hat="hat6.png" role="button" aria-label="Select Pink & White Hat" tabindex="0">
              <img src="hat6.png" alt="Pink & White Hat" class="hat-preview">
              <div class="hat-name">Pink & White</div>
            </div>
            <div class="hat-option" data-hat="hat7.png" role="button" aria-label="Select Purple Hat" tabindex="0">
              <img src="hat7.png" alt="Purple Hat" class="hat-preview">
              <div class="hat-name">Purple</div>
            </div>
            <div class="hat-option" data-hat="hat8.png" role="button" aria-label="Select Beige & Green Hat" tabindex="0">
              <img src="hat8.png" alt="Beige & Green Hat" class="hat-preview">
              <div class="hat-name">Beige & Green</div>
            </div>
          </div>
        </div>

        <!-- Feature 3: Controls Info -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">3</div>
            Drag / Resize / Rotate
          </div>
          <div class="controls-info">
            <h4>Hat Controls:</h4>
            <ul>
              <li>Drag to move position</li>
              <li>Drag corners to resize</li>
              <li>Use rotation handle to rotate</li>
              <li>Double-click to select/deselect</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="canvas-area">
        <div class="canvas-container">
          <canvas id="canvas" width="600" height="450"></canvas>
        </div>
        
        <!-- Feature 4: Download -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">4</div>
            Download Final Image
          </div>
          <button class="download-btn" onclick="downloadImage()" id="downloadBtn" disabled aria-label="Download your creation">
            📥 Download Your Creation
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, checking Fabric.js...');
      
      if (typeof fabric === 'undefined') {
        alert('Fabric.js failed to load. Please check your internet connection or CDN access.');
        console.error('Fabric.js is not defined.');
        return;
      }
      
      console.log('Fabric.js loaded successfully, version:', fabric.version);
      
      const canvas = new fabric.Canvas('canvas', {
        backgroundColor: '#f8f9fa',
        enableRetinaScaling: true,
        allowTouchScrolling: false
      });
      
      // Enhanced mobile touch support
      if ('ontouchstart' in window) {
        canvas.on('touch:gesture', function(e) {
          e.e.preventDefault();
          e.e.stopPropagation();
        });
        
        canvas.on('touch:drag', function(e) {
          e.e.preventDefault();
          e.e.stopPropagation();
        });
      }
      
      console.log('Canvas initialized successfully');
      let hatImage = null;
      let backgroundImage = null;

      // Responsive canvas sizing
      function resizeCanvas() {
        const container = document.querySelector('.canvas-container');
        const containerWidth = container.clientWidth - 40; // Account for padding
        const aspectRatio = 450 / 600; // Original height/width ratio
        
        let newWidth = Math.min(containerWidth, 600);
        let newHeight = newWidth * aspectRatio;
        
        // Ensure minimum size for mobile
        if (window.innerWidth <= 480) {
          newWidth = Math.max(newWidth, 280);
          newHeight = newWidth * aspectRatio;
        }
        
        canvas.setDimensions({
          width: newWidth,
          height: newHeight
        });
        
        canvas.renderAll();
      }
      
      // Initial resize and window resize listener
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      window.addEventListener('orientationchange', function() {
        setTimeout(resizeCanvas, 100);
      });

      // Upload user image with drag and drop
      const uploadArea = document.querySelector('.upload-area');
      const uploadInput = document.getElementById('upload');

      // Enhanced keyboard support for upload area
      uploadArea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          uploadInput.click();
        }
      });

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleImageUpload(files[0]);
        }
      });

      uploadInput.addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
          handleImageUpload(e.target.files[0]);
        }
      });

      function handleImageUpload(file) {
        console.log('handleImageUpload called with file:', file);
        console.log('File type:', file.type);
        console.log('File size:', file.size);
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file (JPEG, PNG, GIF, etc.)');
          return;
        }
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('File size too large. Please select an image smaller than 10MB.');
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function (f) {
          console.log('FileReader loaded successfully');
          console.log('Data URL length:', f.target.result.length);
          
          // Create a new image to test loading
          const testImg = new Image();
          testImg.onload = function() {
            console.log('Test image loaded successfully. Dimensions:', testImg.width, 'x', testImg.height);
            
            fabric.Image.fromURL(f.target.result, function (img) {
              if (!img) {
                alert('Failed to create fabric image. Please try a different image.');
                console.error('fabric.Image.fromURL returned null');
                return;
              }
              
              console.log('Fabric image created successfully');
              
              // Clear canvas
              canvas.clear();
              canvas.backgroundColor = '#f8f9fa';
              
              // Scale image to fit canvas
              const canvasWidth = canvas.getWidth();
              const canvasHeight = canvas.getHeight();
              const imgWidth = img.width;
              const imgHeight = img.height;
              
              console.log('Canvas dimensions:', canvasWidth, 'x', canvasHeight);
              console.log('Image dimensions:', imgWidth, 'x', imgHeight);
              
              const scale = Math.min(canvasWidth / imgWidth, canvasHeight / imgHeight);
              console.log('Calculated scale:', scale);
              
              img.scale(scale);
              
              // Center the image
              img.set({
                left: (canvasWidth - img.getScaledWidth()) / 2,
                top: (canvasHeight - img.getScaledHeight()) / 2,
                selectable: false,
                evented: false
              });
              
              backgroundImage = img;
              canvas.add(img);
              canvas.sendToBack(img);
              canvas.renderAll();
              
              console.log('Image added to canvas successfully');
              console.log('Canvas objects after upload:', canvas.getObjects().length);
              
              // Enable download button
              document.getElementById('downloadBtn').disabled = false;
              
              // Update upload area text
              const uploadText = uploadArea.querySelector('.upload-text');
              const uploadHint = uploadArea.querySelector('.upload-hint');
              if (uploadText) uploadText.textContent = '✅ Image uploaded successfully!';
              if (uploadHint) uploadHint.textContent = 'Click to upload a different image';
              
            }, {
              crossOrigin: 'anonymous'
            });
          };
          
          testImg.onerror = function() {
            alert('Failed to load the image. The file may be corrupt or in an unsupported format.');
            console.error('Test image failed to load');
          };
          
          testImg.src = f.target.result;
        };
        
        reader.onerror = function() {
          alert('Failed to read the image file. Please try another image.');
          console.error('FileReader error:', reader.error);
        };
        
        reader.readAsDataURL(file);
      }

      // Enhanced hat selection with keyboard support
      document.querySelectorAll('.hat-option').forEach(option => {
        option.addEventListener('click', function() {
          selectHat(this);
        });
        
        option.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectHat(this);
          }
        });
      });

      function selectHat(element) {
        // Remove previous selection
        document.querySelectorAll('.hat-option').forEach(opt => opt.classList.remove('selected'));
        // Add selection to current
        element.classList.add('selected');
        
        const hatPath = element.dataset.hat;
        loadHat(hatPath);
      }

      function loadHat(hatPath) {
        console.log('Loading hat:', hatPath);
        
        fabric.Image.fromURL(hatPath, function (img) {
          if (!img) {
            console.error('Failed to load hat image:', hatPath);
            alert('Failed to load hat image. Please try again.');
            return;
          }
          
          console.log('Hat loaded successfully:', hatPath);
          
          // Remove previous hat
          if (hatImage) {
            canvas.remove(hatImage);
          }
          
          // Configure hat with enhanced mobile support
          const canvasWidth = canvas.getWidth();
          const canvasHeight = canvas.getHeight();
          
          // Scale hat appropriately for canvas size
          const hatScale = Math.min(canvasWidth / 600, canvasHeight / 450) * 0.3;
          
          img.set({
            left: canvasWidth / 2 - (img.width * hatScale) / 2,
            top: canvasHeight * 0.15,
            hasRotatingPoint: true,
            cornerColor: '#667eea',
            cornerSize: window.innerWidth <= 768 ? 16 : 12, // Larger corners on mobile
            transparentCorners: false,
            borderColor: '#667eea',
            borderScaleFactor: 2,
            scaleX: hatScale,
            scaleY: hatScale,
            minScaleLimit: 0.1,
            maxScaleLimit: 2,
            // Enhanced touch support
            touchCornerSize: window.innerWidth <= 768 ? 24 : 16,
            selectionLineWidth: window.innerWidth <= 768 ? 3 : 2
          });
          
          hatImage = img;
          canvas.add(img);
          canvas.setActiveObject(img);
          canvas.renderAll();
          
          console.log('Hat added to canvas successfully');
        }, {
          crossOrigin: 'anonymous'
        });
      }

      // Enhanced download function
      window.downloadImage = function() {
        if (!backgroundImage) {
          alert('Please upload an image first!');
          return;
        }
        
        try {
          // Deselect all objects before export
          canvas.discardActiveObject();
          canvas.renderAll();
          
          // Create download link
          const link = document.createElement('a');
          link.download = 'bapper-pfp-' + Date.now() + '.png';
          link.href = canvas.toDataURL('image/png', 1.0);
          
          // Trigger download
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          console.log('Image downloaded successfully');
        } catch (error) {
          console.error('Download failed:', error);
          alert('Failed to download image. Please try again.');
        }
      };

      // Enhanced keyboard navigation
      document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;
        
        const activeObject = canvas.getActiveObject();
        if (!activeObject) return;
        
        const step = e.shiftKey ? 10 : 1;
        
        switch(e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            activeObject.set('left', activeObject.left - step);
            break;
          case 'ArrowRight':
            e.preventDefault();
            activeObject.set('left', activeObject.left + step);
            break;
          case 'ArrowUp':
            e.preventDefault();
            activeObject.set('top', activeObject.top - step);
            break;
          case 'ArrowDown':
            e.preventDefault();
            activeObject.set('top', activeObject.top + step);
            break;
          case 'Delete':
          case 'Backspace':
            e.preventDefault();
            if (activeObject === hatImage) {
              canvas.remove(hatImage);
              hatImage = null;
              document.querySelectorAll('.hat-option').forEach(opt => opt.classList.remove('selected'));
            }
            break;
        }
        
        canvas.renderAll();
      });

      console.log('Bapper Hat Generator initialized successfully with enhanced mobile support');
    });
  </script>
</body>
</html>

