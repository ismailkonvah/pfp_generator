<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <title>Bapper Hat Generator</title>
  <style>
    /* Mobile-first CSS - starts with mobile styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 8px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      padding: 16px;
      text-align: center;
      color: white;
    }

    .header h1 {
      font-size: 1.25rem;
      margin-bottom: 4px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      font-weight: 700;
    }

    .header p {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* Mobile-first main content - single column by default */
    .main-content {
      padding: 12px;
    }

    .controls-panel {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .feature-section {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e9ecef;
    }

    .feature-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .feature-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .feature-icon {
      width: 18px;
      height: 18px;
      background: #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      flex-shrink: 0;
    }

    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 6px;
      padding: 16px;
      text-align: center;
      background: #f8f9ff;
      transition: all 0.2s ease;
      cursor: pointer;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      touch-action: manipulation;
    }

    .upload-area:active {
      background: #e6f3ff;
      border-color: #4c51bf;
      transform: scale(0.98);
    }

    .upload-input {
      display: none;
    }

    .upload-text {
      color: #667eea;
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .upload-hint {
      color: #718096;
      font-size: 0.7rem;
    }

    .image-info {
      background: #e6f3ff;
      border-radius: 4px;
      padding: 6px;
      margin-top: 6px;
      font-size: 0.7rem;
      color: #4a5568;
      display: none;
    }

    /* Mobile-first hat grid - 2 columns by default */
    .hat-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-top: 8px;
    }

    .hat-option {
      border: 2px solid transparent;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      background: white;
      text-align: center;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .hat-option:active {
      transform: scale(0.95);
      background: #f0f4ff;
    }

    .hat-option.selected {
      border-color: #667eea;
      background: #f0f4ff;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    .hat-preview {
      width: 28px;
      height: 28px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 3px;
    }

    .hat-name {
      font-size: 0.65rem;
      color: #4a5568;
      font-weight: 500;
      line-height: 1.1;
    }

    .controls-info {
      background: #e6fffa;
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
    }

    .controls-info h4 {
      color: #2d3748;
      margin-bottom: 6px;
      font-size: 0.8rem;
    }

    .controls-info ul {
      list-style: none;
      color: #4a5568;
    }

    .controls-info li {
      margin-bottom: 2px;
      padding-left: 12px;
      position: relative;
      font-size: 0.7rem;
    }

    .controls-info li:before {
      content: "â€¢";
      color: #667eea;
      font-weight: bold;
      position: absolute;
      left: 0;
    }

    .canvas-area {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .canvas-container {
      background: white;
      border-radius: 6px;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 12px;
      overflow: hidden;
    }

    #canvas {
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      width: 100%;
      max-width: 100%;
      height: auto;
      touch-action: none;
      display: block;
    }

    .download-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
      width: 100%;
      min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .download-btn:active {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(102, 126, 234, 0.6);
    }

    .download-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .quality-info {
      background: #f0f9ff;
      border-radius: 4px;
      padding: 6px;
      margin-top: 6px;
      font-size: 0.7rem;
      color: #1e40af;
      display: none;
    }

    /* Tablet styles (min-width: 481px) */
    @media screen and (min-width: 481px) {
      body {
        padding: 12px;
      }

      .container {
        border-radius: 16px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 6px;
      }

      .header p {
        font-size: 0.9rem;
      }

      .main-content {
        padding: 16px;
      }

      .controls-panel {
        padding: 16px;
        margin-bottom: 16px;
      }

      .feature-section {
        margin-bottom: 20px;
        padding-bottom: 16px;
      }

      .feature-title {
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .feature-icon {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }

      .upload-area {
        padding: 20px;
        min-height: 80px;
      }

      .upload-text {
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .upload-hint {
        font-size: 0.8rem;
      }

      .hat-grid {
        gap: 8px;
        margin-top: 10px;
      }

      .hat-option {
        padding: 8px;
        min-height: 70px;
      }

      .hat-preview {
        width: 35px;
        height: 35px;
        margin-bottom: 4px;
      }

      .hat-name {
        font-size: 0.7rem;
      }

      .controls-info {
        padding: 12px;
        margin-top: 10px;
      }

      .controls-info h4 {
        font-size: 0.9rem;
        margin-bottom: 8px;
      }

      .controls-info li {
        font-size: 0.8rem;
        margin-bottom: 3px;
      }

      .canvas-area {
        padding: 16px;
      }

      .canvas-container {
        padding: 12px;
        margin-bottom: 16px;
      }

      .download-btn {
        padding: 14px 20px;
        font-size: 0.9rem;
        max-width: 300px;
      }
    }

    /* Desktop styles (min-width: 769px) */
    @media screen and (min-width: 769px) {
      body {
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        border-radius: 20px;
      }

      .header {
        padding: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        padding: 30px;
      }

      .controls-panel {
        padding: 25px;
        margin-bottom: 0;
      }

      .feature-section {
        margin-bottom: 30px;
        padding-bottom: 25px;
        border-bottom: 2px solid #e9ecef;
      }

      .feature-title {
        font-size: 1.3rem;
        margin-bottom: 15px;
      }

      .feature-icon {
        width: 24px;
        height: 24px;
        font-size: 14px;
      }

      .upload-area {
        padding: 30px;
        min-height: 120px;
      }

      .upload-text {
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .upload-hint {
        font-size: 0.9rem;
      }

      .hat-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      .hat-option {
        padding: 10px;
        min-height: 100px;
      }

      .hat-preview {
        width: 60px;
        height: 60px;
        margin-bottom: 8px;
      }

      .hat-name {
        font-size: 0.8rem;
      }

      .controls-info {
        padding: 20px;
        margin-top: 15px;
      }

      .controls-info h4 {
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .controls-info li {
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .canvas-area {
        padding: 25px;
      }

      .canvas-container {
        padding: 20px;
        margin-bottom: 20px;
      }

      .download-btn {
        padding: 15px 30px;
        font-size: 1.1rem;
        max-width: none;
        width: auto;
      }
    }

    /* Remove hover effects on touch devices */
    @media (hover: none) and (pointer: coarse) {
      .hat-option:hover {
        transform: none;
        box-shadow: none;
      }

      .download-btn:hover {
        transform: none;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: #f8f9ff;
      }
    }

    /* Landscape orientation adjustments for mobile */
    @media screen and (max-width: 768px) and (orientation: landscape) {
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .controls-panel {
        margin-bottom: 0;
      }

      .hat-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
      }

      .hat-option {
        min-height: 50px;
        padding: 4px;
      }

      .hat-preview {
        width: 24px;
        height: 24px;
      }

      .hat-name {
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1> â‚¿appers PFP Generator</h1>
      <p>Create amazing pfp combinations with your photos!</p>
    </div>
    <p style="text-align: center; font-size: 14px; color: #667eea; margin-top: 20px;">
  Made by 
  <a href="https://x.com/boringcrypto_" target="_blank" style="color: #764ba2; font-weight: bold; text-decoration: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" width="14" height="14" style="vertical-align: middle; margin-right: 4px;">
      <path d="M93.6 14H110L72.7 56.1L117 106H81.7L54.7 75.2L24.7 106H8L48.2 61.2L4 14H41.2L65.2 42.2L93.6 14ZM86.2 96H97.2L36.2 24H24.2L86.2 96Z" fill="currentColor"/>
    </svg>
    @boringcrypto_
  </a>
</p>
    <div class="main-content">
      <div class="controls-panel">
        <!-- Feature 1: Upload Image -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">1</div>
            Upload Any Image
          </div>
          <div class="upload-area" onclick="document.getElementById('upload').click()" role="button" aria-label="Upload image area" tabindex="0">
            <input type="file" id="upload" class="upload-input" accept="image/*" aria-label="Upload image" />
            <div class="upload-text">ðŸ“¸ Click to upload your image</div>
            <div class="upload-hint">or drag and drop here</div>
          </div>
          <div class="image-info" id="imageInfo"></div>
        </div>

        <!-- Feature 2: Choose Hat -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">2</div>
            Choose from 8 Hats
          </div>
          <div class="hat-grid">
            <div class="hat-option" data-hat="hat1.png" role="button" aria-label="Select Orange Hat" tabindex="0">
              <img src="hat1.png" alt="Orange Hat" class="hat-preview">
              <div class="hat-name">Hat 1</div>
            </div>
            <div class="hat-option" data-hat="hat2.png" role="button" aria-label="Select Black & Red Hat" tabindex="0">
              <img src="hat2.png" alt="Black & Red Hat" class="hat-preview">
              <div class="hat-name">Hat 2</div>
            </div>
            <div class="hat-option" data-hat="hat3.png" role="button" aria-label="Select Green & Yellow Hat" tabindex="0">
              <img src="hat3.png" alt="Green & Yellow Hat" class="hat-preview">
              <div class="hat-name">Hat 3</div>
            </div>
            <div class="hat-option" data-hat="hat4.png" role="button" aria-label="Select Blue & White Hat" tabindex="0">
              <img src="hat4.png" alt="Blue & White Hat" class="hat-preview">
              <div class="hat-name">Hat 4</div>
            </div>
            <div class="hat-option" data-hat="hat5.png" role="button" aria-label="Select Red & Gray Hat" tabindex="0">
              <img src="hat5.png" alt="Red & Gray Hat" class="hat-preview">
              <div class="hat-name">Hat 5</div>
            </div>
            <div class="hat-option" data-hat="hat6.png" role="button" aria-label="Select Pink & White Hat" tabindex="0">
              <img src="hat6.png" alt="Pink & White Hat" class="hat-preview">
              <div class="hat-name">Hat 6</div>
            </div>
            <div class="hat-option" data-hat="hat7.png" role="button" aria-label="Select Purple Hat" tabindex="0">
              <img src="hat7.png" alt="Purple Hat" class="hat-preview">
              <div class="hat-name">Hat 7</div>
            </div>
            <div class="hat-option" data-hat="hat8.png" role="button" aria-label="Select Beige & Green Hat" tabindex="0">
              <img src="hat8.png" alt="Beige & Green Hat" class="hat-preview">
              <div class="hat-name">Hat 8</div>
            </div>
          </div>
        </div>

        <!-- Feature 3: Controls Info -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">3</div>
            Drag / Resize / Rotate
          </div>
          <div class="controls-info">
            <h4>Hat Controls:</h4>
            <ul>
              <li>Drag to move position</li>
              <li>Drag corners to resize</li>
              <li>Use rotation handle to rotate</li>
              <li>Double-click to select/deselect</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="canvas-area">
        <div class="canvas-container">
          <canvas id="canvas" width="280" height="210"></canvas>
        </div>
        
        <!-- Feature 4: Download -->
        <div class="feature-section">
          <div class="feature-title">
            <div class="feature-icon">4</div>
            Download Final Image
          </div>
          <button class="download-btn" onclick="downloadImage()" id="downloadBtn" disabled aria-label="Download your creation">
            ðŸ“¥ Download Your Creation
          </button>
          <div class="quality-info" id="qualityInfo"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, checking Fabric.js...');
      
      if (typeof fabric === 'undefined') {
        alert('Fabric.js failed to load. Please check your internet connection or CDN access.');
        console.error('Fabric.js is not defined.');
        return;
      }
      
      console.log('Fabric.js loaded successfully, version:', fabric.version);
      
      // Initialize canvas with mobile-optimized settings
      const canvas = new fabric.Canvas('canvas', {
        backgroundColor: '#f8f9fa',
        enableRetinaScaling: true,
        allowTouchScrolling: false,
        selection: true,
        preserveObjectStacking: true
      });
      
      // Enhanced mobile touch support
      if ('ontouchstart' in window) {
        canvas.on('touch:gesture', function(e) {
          e.e.preventDefault();
          e.e.stopPropagation();
        });
        
        canvas.on('touch:drag', function(e) {
          e.e.preventDefault();
          e.e.stopPropagation();
        });

        // Prevent scrolling when touching canvas
        canvas.wrapperEl.addEventListener('touchstart', function(e) {
          e.preventDefault();
        }, { passive: false });

        canvas.wrapperEl.addEventListener('touchmove', function(e) {
          e.preventDefault();
        }, { passive: false });
      }
      
      console.log('Canvas initialized successfully');
      let hatImage = null;
      let backgroundImage = null;
      let originalImageData = null; // Store original image data for high-quality export
      let originalImageDimensions = { width: 0, height: 0 };
      let uploadedImageAspectRatio = null; // Store the aspect ratio of the uploaded image

      // Adaptive canvas sizing based on uploaded image aspect ratio
      function resizeCanvas() {
        const container = document.querySelector('.canvas-container');
        const containerWidth = container.clientWidth - 16; // Account for padding
        
        let maxWidth, maxHeight;
        
        // Device-appropriate maximum sizes
        if (window.innerWidth < 481) {
          // Mobile: smaller maximum size
          maxWidth = Math.min(containerWidth, 300);
          maxHeight = 400; // Allow taller images on mobile
        } else if (window.innerWidth < 769) {
          // Tablet: medium maximum size
          maxWidth = Math.min(containerWidth, 450);
          maxHeight = 500;
        } else {
          // Desktop: larger maximum size
          maxWidth = Math.min(containerWidth, 600);
          maxHeight = 600;
        }
        
        let newWidth, newHeight;
        
        if (uploadedImageAspectRatio && backgroundImage) {
          // Use the uploaded image's aspect ratio
          if (uploadedImageAspectRatio >= 1) {
            // Landscape or square image
            newWidth = maxWidth;
            newHeight = newWidth / uploadedImageAspectRatio;
            
            // If height exceeds max, constrain by height
            if (newHeight > maxHeight) {
              newHeight = maxHeight;
              newWidth = newHeight * uploadedImageAspectRatio;
            }
          } else {
            // Portrait image
            newHeight = maxHeight;
            newWidth = newHeight * uploadedImageAspectRatio;
            
            // If width exceeds max, constrain by width
            if (newWidth > maxWidth) {
              newWidth = maxWidth;
              newHeight = newWidth / uploadedImageAspectRatio;
            }
          }
        } else {
          // Default 4:3 aspect ratio when no image is uploaded
          newWidth = maxWidth;
          newHeight = newWidth * 0.75;
        }
        
        // Ensure minimum size
        newWidth = Math.max(newWidth, 200);
        newHeight = Math.max(newHeight, 150);
        
        console.log('Resizing canvas to:', newWidth, 'x', newHeight, 'Aspect ratio:', uploadedImageAspectRatio);
        
        canvas.setDimensions({
          width: newWidth,
          height: newHeight
        });
        
        // Rescale existing background image to fit new canvas
        if (backgroundImage) {
          const scale = Math.min(newWidth / backgroundImage.width, newHeight / backgroundImage.height);
          backgroundImage.scale(scale);
          backgroundImage.set({
            left: (newWidth - backgroundImage.getScaledWidth()) / 2,
            top: (newHeight - backgroundImage.getScaledHeight()) / 2
          });
        }
        
        // Rescale and reposition hat relative to the background image
        if (hatImage && backgroundImage) {
          const bgScaledWidth = backgroundImage.getScaledWidth();
          const bgScaledHeight = backgroundImage.getScaledHeight();
          
          // Scale hat proportionally to the background image size
          const hatScale = Math.min(bgScaledWidth / 400, bgScaledHeight / 400) * 0.25;
          
          hatImage.set({
            scaleX: hatScale,
            scaleY: hatScale
          });
          
          // Reposition hat relative to background image center
          const bgCenterX = backgroundImage.left + bgScaledWidth / 2;
          const bgCenterY = backgroundImage.top + bgScaledHeight / 2;
          
          hatImage.set({
            left: bgCenterX - (hatImage.width * hatScale) / 2,
            top: bgCenterY - bgScaledHeight * 0.35 // Position hat in upper portion of image
          });
        }
        
        canvas.renderAll();
      }
      
      // Initial resize and window resize listener
      resizeCanvas();
      
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(resizeCanvas, 100);
      });
      
      window.addEventListener('orientationchange', function() {
        setTimeout(resizeCanvas, 300);
      });

      // Upload user image with drag and drop
      const uploadArea = document.querySelector('.upload-area');
      const uploadInput = document.getElementById('upload');

      // Enhanced keyboard support for upload area
      uploadArea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          uploadInput.click();
        }
      });

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleImageUpload(files[0]);
        }
      });

      uploadInput.addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
          handleImageUpload(e.target.files[0]);
        }
      });

      function handleImageUpload(file) {
        console.log('handleImageUpload called with file:', file);
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file (JPEG, PNG, GIF, etc.)');
          return;
        }
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('File size too large. Please select an image smaller than 10MB.');
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function (f) {
          const testImg = new Image();
          testImg.onload = function() {
            console.log('Original image dimensions:', testImg.width, 'x', testImg.height);
            
            // Store original image data and dimensions for high-quality export
            originalImageData = f.target.result;
            originalImageDimensions = { width: testImg.width, height: testImg.height };
            
            // Calculate and store the aspect ratio
            uploadedImageAspectRatio = testImg.width / testImg.height;
            console.log('Image aspect ratio:', uploadedImageAspectRatio);
            
            // Update image info display
            const imageInfo = document.getElementById('imageInfo');
            const aspectRatioText = uploadedImageAspectRatio > 1 ? 'Landscape' : 
                                   uploadedImageAspectRatio < 1 ? 'Portrait' : 'Square';
            imageInfo.textContent = `${testImg.width}Ã—${testImg.height}px (${aspectRatioText})`;
            imageInfo.style.display = 'block';
            
            // Update quality info
            const qualityInfo = document.getElementById('qualityInfo');
            qualityInfo.textContent = `Canvas will adapt to image ratio. Download: ${testImg.width}Ã—${testImg.height}px`;
            qualityInfo.style.display = 'block';
            
            fabric.Image.fromURL(f.target.result, function (img) {
              if (!img) {
                alert('Failed to create fabric image. Please try a different image.');
                return;
              }
              
              // Clear canvas
              canvas.clear();
              canvas.backgroundColor = '#f8f9fa';
              
              // Store the background image reference
              backgroundImage = img;
              
              // Resize canvas to match image aspect ratio
              resizeCanvas();
              
              // Scale image to fit the new canvas dimensions
              const canvasWidth = canvas.getWidth();
              const canvasHeight = canvas.getHeight();
              const scale = Math.min(canvasWidth / img.width, canvasHeight / img.height);
              
              img.scale(scale);
              
              // Center the image
              img.set({
                left: (canvasWidth - img.getScaledWidth()) / 2,
                top: (canvasHeight - img.getScaledHeight()) / 2,
                selectable: false,
                evented: false
              });
              
              canvas.add(img);
              canvas.sendToBack(img);
              canvas.renderAll();
              
              // Enable download button
              document.getElementById('downloadBtn').disabled = false;
              
              // Update upload area text
              const uploadText = uploadArea.querySelector('.upload-text');
              const uploadHint = uploadArea.querySelector('.upload-hint');
              if (uploadText) uploadText.textContent = 'âœ… Image uploaded successfully!';
              if (uploadHint) uploadHint.textContent = 'Canvas adapted to image ratio';
              
            }, {
              crossOrigin: 'anonymous'
            });
          };
          
          testImg.onerror = function() {
            alert('Failed to load the image. The file may be corrupt or in an unsupported format.');
          };
          
          testImg.src = f.target.result;
        };
        
        reader.onerror = function() {
          alert('Failed to read the image file. Please try another image.');
        };
        
        reader.readAsDataURL(file);
      }

      // Enhanced hat selection with keyboard support
      document.querySelectorAll('.hat-option').forEach(option => {
        option.addEventListener('click', function() {
          selectHat(this);
        });
        
        option.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectHat(this);
          }
        });
      });

      function selectHat(element) {
        // Remove previous selection
        document.querySelectorAll('.hat-option').forEach(opt => opt.classList.remove('selected'));
        // Add selection to current
        element.classList.add('selected');
        
        const hatPath = element.dataset.hat;
        loadHat(hatPath);
      }

      function loadHat(hatPath) {
        console.log('Loading hat:', hatPath);
        
        fabric.Image.fromURL(hatPath, function (img) {
          if (!img) {
            console.error('Failed to load hat image:', hatPath);
            alert('Failed to load hat image. Please try again.');
            return;
          }
          
          // Remove previous hat
          if (hatImage) {
            canvas.remove(hatImage);
          }
          
          // Configure hat with adaptive sizing based on background image
          const canvasWidth = canvas.getWidth();
          const canvasHeight = canvas.getHeight();
          
          let hatScale;
          if (backgroundImage) {
            // Scale hat relative to the background image size
            const bgScaledWidth = backgroundImage.getScaledWidth();
            const bgScaledHeight = backgroundImage.getScaledHeight();
            hatScale = Math.min(bgScaledWidth / 400, bgScaledHeight / 400) * 0.25;
          } else {
            // Fallback scaling when no background image
            hatScale = Math.min(canvasWidth / 400, canvasHeight / 400) * 0.3;
          }
          
          // Position hat relative to background image if available
          let hatLeft, hatTop;
          if (backgroundImage) {
            const bgCenterX = backgroundImage.left + backgroundImage.getScaledWidth() / 2;
            const bgCenterY = backgroundImage.top + backgroundImage.getScaledHeight() / 2;
            
            hatLeft = bgCenterX - (img.width * hatScale) / 2;
            hatTop = bgCenterY - backgroundImage.getScaledHeight() * 0.35; // Upper portion of image
          } else {
            // Fallback positioning
            hatLeft = canvasWidth / 2 - (img.width * hatScale) / 2;
            hatTop = canvasHeight * 0.15;
          }
          
          img.set({
            left: hatLeft,
            top: hatTop,
            hasRotatingPoint: true,
            cornerColor: '#667eea',
            cornerSize: window.innerWidth < 481 ? 20 : (window.innerWidth < 769 ? 16 : 12),
            transparentCorners: false,
            borderColor: '#667eea',
            borderScaleFactor: window.innerWidth < 481 ? 3 : 2,
            scaleX: hatScale,
            scaleY: hatScale,
            minScaleLimit: 0.05,
            maxScaleLimit: 2,
            // Enhanced touch support
            touchCornerSize: window.innerWidth < 481 ? 30 : (window.innerWidth < 769 ? 24 : 16),
            selectionLineWidth: window.innerWidth < 481 ? 4 : (window.innerWidth < 769 ? 3 : 2)
          });
          
          hatImage = img;
          canvas.add(img);
          canvas.setActiveObject(img);
          canvas.renderAll();
          
          console.log('Hat added to canvas successfully with adaptive scaling');
        }, {
          crossOrigin: 'anonymous'
        });
      }

      // Enhanced download function with high-quality export
      window.downloadImage = function() {
        if (!backgroundImage || !originalImageData) {
          alert('Please upload an image first!');
          return;
        }
        
        try {
          // Deselect all objects before export
          canvas.discardActiveObject();
          canvas.renderAll();
          
          // Create a high-resolution canvas for export
          const exportCanvas = document.createElement('canvas');
          const exportCtx = exportCanvas.getContext('2d');
          
          // Use original image dimensions for export
          const exportWidth = originalImageDimensions.width;
          const exportHeight = originalImageDimensions.height;
          
          exportCanvas.width = exportWidth;
          exportCanvas.height = exportHeight;
          
          console.log('Export canvas dimensions:', exportWidth, 'x', exportHeight);
          
          // Load and draw the original background image at full resolution
          const originalImg = new Image();
          originalImg.onload = function() {
            // Draw background image at full resolution
            exportCtx.drawImage(originalImg, 0, 0, exportWidth, exportHeight);
            
            // If there's a hat, draw it proportionally
            if (hatImage) {
              // Calculate hat position and scale relative to original image
              const canvasWidth = canvas.getWidth();
              const canvasHeight = canvas.getHeight();
              
              // Get hat's current position and scale on the display canvas
              const hatLeft = hatImage.left;
              const hatTop = hatImage.top;
              const hatScaleX = hatImage.scaleX;
              const hatScaleY = hatImage.scaleY;
              const hatAngle = hatImage.angle;
              
              // Calculate proportional position and scale for export
              const scaleFactorX = exportWidth / canvasWidth;
              const scaleFactorY = exportHeight / canvasHeight;
              
              const exportHatLeft = hatLeft * scaleFactorX;
              const exportHatTop = hatTop * scaleFactorY;
              const exportHatScaleX = hatScaleX * scaleFactorX;
              const exportHatScaleY = hatScaleY * scaleFactorY;
              
              // Load hat image for export
              const hatImg = new Image();
              hatImg.onload = function() {
                // Save context state
                exportCtx.save();
                
                // Move to hat center for rotation
                const hatCenterX = exportHatLeft + (hatImg.width * exportHatScaleX) / 2;
                const hatCenterY = exportHatTop + (hatImg.height * exportHatScaleY) / 2;
                
                exportCtx.translate(hatCenterX, hatCenterY);
                exportCtx.rotate((hatAngle * Math.PI) / 180);
                
                // Draw hat at high resolution
                exportCtx.drawImage(
                  hatImg,
                  -(hatImg.width * exportHatScaleX) / 2,
                  -(hatImg.height * exportHatScaleY) / 2,
                  hatImg.width * exportHatScaleX,
                  hatImg.height * exportHatScaleY
                );
                
                // Restore context state
                exportCtx.restore();
                
                // Create download link with high-quality image
                const link = document.createElement('a');
                link.download = 'bapper-pfp-adaptive-' + Date.now() + '.png';
                link.href = exportCanvas.toDataURL('image/png', 1.0);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('High-quality adaptive image downloaded successfully');
              };
              
              hatImg.onerror = function() {
                console.error('Failed to load hat image for export');
                // Fallback to regular canvas export
                fallbackDownload();
              };
              
              // Get the hat image source
              const selectedHat = document.querySelector('.hat-option.selected');
              if (selectedHat) {
                hatImg.src = selectedHat.dataset.hat;
              } else {
                // No hat selected, just download background
                const link = document.createElement('a');
                link.download = 'bapper-pfp-adaptive-' + Date.now() + '.png';
                link.href = exportCanvas.toDataURL('image/png', 1.0);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('High-quality background image downloaded successfully');
              }
            } else {
              // No hat, just download the high-resolution background
              const link = document.createElement('a');
              link.download = 'bapper-pfp-adaptive-' + Date.now() + '.png';
              link.href = exportCanvas.toDataURL('image/png', 1.0);
              
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              console.log('High-quality background image downloaded successfully');
            }
          };
          
          originalImg.onerror = function() {
            console.error('Failed to load original image for export');
            fallbackDownload();
          };
          
          originalImg.src = originalImageData;
          
        } catch (error) {
          console.error('High-quality download failed:', error);
          fallbackDownload();
        }
        
        function fallbackDownload() {
          // Fallback to regular canvas export
          const link = document.createElement('a');
          link.download = 'bapper-pfp-adaptive-' + Date.now() + '.png';
          link.href = canvas.toDataURL('image/png', 1.0);
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          console.log('Fallback image downloaded');
        }
      };

      // Enhanced keyboard navigation
      document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;
        
        const activeObject = canvas.getActiveObject();
        if (!activeObject) return;
        
        const step = e.shiftKey ? 10 : 1;
        
        switch(e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            activeObject.set('left', activeObject.left - step);
            break;
          case 'ArrowRight':
            e.preventDefault();
            activeObject.set('left', activeObject.left + step);
            break;
          case 'ArrowUp':
            e.preventDefault();
            activeObject.set('top', activeObject.top - step);
            break;
          case 'ArrowDown':
            e.preventDefault();
            activeObject.set('top', activeObject.top + step);
            break;
          case 'Delete':
          case 'Backspace':
            e.preventDefault();
            if (activeObject === hatImage) {
              canvas.remove(hatImage);
              hatImage = null;
              document.querySelectorAll('.hat-option').forEach(opt => opt.classList.remove('selected'));
            }
            break;
        }
        
        canvas.renderAll();
      });

      console.log('Adaptive Aspect Ratio Bapper Hat Generator initialized successfully');
    });
  </script>
</body>
</html>

